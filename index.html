<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
    <meta name="theme-color" content="#f4b400"/>
    <meta name="description" content="J&M Fast Food - Las hamburguesas que te hacen volver. Pedidos online con env√≠o a domicilio."/>
    <link rel="manifest" href="manifest.json"/>
    <link rel="apple-touch-icon" href="https://i.ibb.co/tTKrch7P/Whats-App-Image-2026-01-31-at-4-04-56-PM.jpg"/>
    <title>J&M Fast Food | Oficial üî•</title>

    <style>
        :root {
            --brand: #f4b400;
            --bg: #0b0b0b;
            --card: rgba(22, 22, 22, 0.75);
            --txt: #fff;
            --muted: #aaa;
            --error: #ff4444;
        }

        * {
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        body {
            background: var(--bg);
            color: var(--txt);
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            padding-top: 0;
            padding-bottom: 110px;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            width: 100%;
            max-width: 100vw;
        }

        /* --- FONDO SUTIL CON TRANSICI√ìN DIN√ÅMICA --- */
        .fire-canvas { 
            position: fixed; 
            inset: 0; 
            z-index: -1; 
            background: radial-gradient(circle at bottom, #1a0f00 0%, #000 80%);
            transition: background 1.5s ease-in-out;
        }
        .fire-canvas.active-category {
            background: radial-gradient(
                circle at bottom, 
                var(--category-bg-color, #1a0f00) 0%, 
                #000 80%
            );
        }
        .sparks {
            position: absolute; 
            width: 100%; 
            height: 100%;
            background-image: radial-gradient(1px 1px at 20px 30px, var(--brand), transparent);
            background-size: 100px 100px; 
            animation: moveSparks 12s linear infinite; 
            opacity: 0.15;
        }
        @keyframes moveSparks { 
            from { transform: translateY(0); } 
            to { transform: translateY(-1000px); } 
        }

        header {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px;
            position: fixed; 
            top: 0; 
            left: 0;
            right: 0;
            width: 100%; 
            max-width: 100vw;
            height: 60px;
            background: rgba(0,0,0,0.95); 
            backdrop-filter: blur(15px); 
            z-index: 1200;
            border-bottom: 1px solid rgba(244,180,0,0.15);
            transform: translateZ(0);
            will-change: transform;
            overflow: hidden;
        }
        header.scrolled { background: rgba(0,0,0,0.98); }
        .logo-container { 
            width: 38px; 
            height: 38px; 
            border-radius: 50%; 
            border: 2px solid var(--brand); 
            overflow: hidden; 
            box-shadow: 0 0 12px rgba(244,180,0,0.3); 
        }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }
        .fire-text { 
            font-size: 17px; 
            font-weight: 900; 
            color: #fff; 
            text-shadow: 0 0 6px rgba(244,180,0,0.4); 
            text-transform: uppercase; 
        }

        /* --- HERO SECTION (VERSI√ìN SUTIL) --- */
        .hero {
            position: relative;
            width: 100%;
            max-width: 100vw;
            height: 45vh;
            min-height: 320px;
            max-height: 400px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .hero-bg {
            position: absolute;
            inset: 0;
            background:
                linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(11,11,11,0.95) 100%),
                url('https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=800&q=80') center center / cover no-repeat;
            z-index: -1;
            filter: brightness(0.6) contrast(1.1);
        }
        .hero-logo {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: 2px solid var(--brand);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            margin-bottom: 12px;
        }
        .hero-logo img { width: 100%; height: 100%; object-fit: cover; }
        .hero-title {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 6px 0;
            text-align: center;
        }
        .hero-tagline {
            font-size: 13px;
            color: rgba(255,255,255,0.75);
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
            margin: 0 0 14px 0;
            text-align: center;
            font-weight: 400;
        }
        .hero-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 14px;
        }
        .hero-badge {
            background: rgba(244,180,0,0.12);
            border: 1px solid rgba(244,180,0,0.25);
            color: rgba(244,180,0,0.85);
            padding: 5px 11px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }
        .hero-cta {
            background: var(--brand);
            color: #000;
            border: none;
            padding: 11px 26px;
            border-radius: 22px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 7px;
            box-shadow: 0 4px 12px rgba(244,180,0,0.3);
            transition: all 0.3s ease;
        }
        .hero-cta:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 18px rgba(244,180,0,0.4); 
        }
        .hero-scroll-indicator {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.35);
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.6;
        }

        /* Promo banner removido para mejor UX sticky */

        /* BOT√ìN INSTALAR APP (PWA) */
        .install-btn {
            position: fixed;
            top: 70px;
            right: 15px;
            background: linear-gradient(135deg, var(--brand) 0%, #ff6b35 100%);
            color: #000;
            border: none;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 900;
            cursor: pointer;
            z-index: 1250;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(244,180,0,0.4);
            animation: pulseInstall 2s infinite;
            transition: all 0.3s ease;
        }
        .install-btn.show {
            display: flex;
        }
        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244,180,0,0.6);
        }
        @keyframes pulseInstall {
            0%, 100% { box-shadow: 0 4px 15px rgba(244,180,0,0.4); }
            50% { box-shadow: 0 4px 25px rgba(244,180,0,0.7); }
        }

        .menu-wrapper { padding-top: 20px; }

        .tabs {
            display: flex; gap: 10px; overflow-x: auto; padding: 12px 15px;
            background: rgba(0,0,0,0.98); 
            position: sticky; 
            top: 60px;
            left: 0;
            right: 0;
            width: 100%; 
            max-width: 100vw;
            z-index: 1100; 
            scrollbar-width: none; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(244,180,0,0.1);
            box-sizing: border-box;
        }
        .tabs::-webkit-scrollbar { display: none; }
        .tabs button {
            background: #1a1a1a; color: #888; border: none;
            padding: 14px 26px; 
            border-radius: 25px; 
            font-weight: 700; 
            font-size: 15px;
            white-space: nowrap; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            min-width: fit-content;
        }
        
        /* Tama√±o a√∫n m√°s grande en m√≥viles peque√±os */
        @media (max-width: 480px) {
            .tabs button {
                padding: 16px 28px;
                font-size: 16px;
            }
        }
        .tabs button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--category-color, var(--brand));
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .tabs button.active::before {
            opacity: 1;
        }
        .tabs button span {
            position: relative;
            z-index: 1;
        }
        .tabs button.active { 
            color: #000; 
            box-shadow: 0 0 20px var(--category-color, var(--brand));
        }

        .category-title { 
            padding: 25px 20px 15px; 
            font-size: 18px; 
            font-weight: 900; 
            text-transform: uppercase;
            position: relative;
            z-index: 1;
        }
        
        .menu-section {
            position: relative;
            padding: 20px 0;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .menu-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.6s ease;
            pointer-events: none;
            z-index: 0;
        }
        
        .menu-section.active::before {
            opacity: 1;
        }
        
        #menu-container { 
            padding: 0 15px; 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            max-width: 900px; 
            margin: auto;
            position: relative;
            z-index: 1;
            width: 100%;
            box-sizing: border-box;
        }

        .item { 
            background: var(--card); 
            border-radius: 20px; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid rgba(255,255,255,0.05); 
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, var(--category-color, var(--brand)) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 0;
        }
        
        .item:hover::before {
            opacity: 0.08;
        }
        
        .item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .item-img-cont { width: 100%; aspect-ratio: 1/1; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        .item-img-cont img { width: 100%; height: 100%; object-fit: cover; }

        .qty-btn {
            position: absolute; top: 10px; right: 10px; height: 38px; width: 38px;
            border-radius: 19px; background: var(--brand); color: #000;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; border: none; cursor: pointer; transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10;
        }
        .qty-btn.expanded { width: 105px; }
        .qty-btn button { background: none; border: none; width: 30px; height: 30px; font-weight: 900; display: none; align-items: center; justify-content: center; font-size: 20px; color: #000; }
        .qty-btn.expanded button { display: flex; }

        .item-info { padding: 12px; }
        .item-name { font-size: 14px; font-weight: 700; color: #fff; }
        .item-desc { font-size: 11px; color: var(--muted); margin-bottom: 6px; line-height: 1.2; height: 2.4em; overflow: hidden; }
        .item-price { font-weight: 800; color: var(--brand); }

        .cart-float {
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            width: calc(100% - 30px);
            max-width: 420px; 
            height: 65px;
            background: var(--brand); 
            border-radius: 35px;
            display: none; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 10px 0 25px; 
            font-weight: 900; 
            color: #000; 
            z-index: 1500; 
            border: none;
            box-shadow: 0 8px 25px rgba(244, 180, 0, 0.5);
            cursor: pointer;
        }
        
        /* Mejor ajuste en m√≥vil */
        @media (max-width: 480px) {
            .cart-float {
                width: calc(100% - 20px);
                height: 70px;
                bottom: 15px;
                padding: 0 8px 0 20px;
            }
        }

        .cart-black-box { background: #000; color: #fff; padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px; position: relative; }
        #cart-count {
            position: absolute; top: -8px; left: -8px; background: #ff3b30; color: #fff; font-size: 12px;
            width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid #000;
        }

        .form-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.96); backdrop-filter: blur(20px); z-index: 2000; display: none; padding: 20px; flex-direction: column; overflow-y: auto; }
        .close-modal {
            position: absolute; top: 15px; right: 15px; width: 42px; height: 42px;
            border-radius: 50%; border: none; background: #222; color: #fff;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        .resumen-box { background: rgba(255,255,255,0.03); border: 1px solid #222; border-radius: 20px; padding: 15px; margin-bottom: 20px; }
        
        .input-field { 
            background: #111; 
            border: 1px solid #333; 
            padding: 15px; 
            border-radius: 12px; 
            color: #fff; 
            width: 100%; 
            margin-bottom: 12px; 
            box-sizing: border-box; 
            font-size: 16px; 
            transition: 0.3s;
            appearance: none;
        }
        
        select.input-field {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23f4b400' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
            cursor: pointer;
            color: #fff !important;
        }
        select.input-field option {
            background-color: #1a1a1a;
            color: #fff;
        }

        .input-field:focus { border-color: var(--brand); outline: none; }
        .input-field.required-error { border: 1px solid var(--error); background: rgba(255, 68, 68, 0.1); animation: shake 0.4s; }

        .gps-notice-box {
            background: rgba(244, 180, 0, 0.08);
            border: 1px solid rgba(244, 180, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: -5px;
            margin-bottom: 15px;
            text-align: center;
        }
        .gps-notice-box p { margin: 0 0 10px 0; font-size: 11px; color: var(--muted); line-height: 1.4; }
        .btn-gps-action {
            background: rgba(76,175,80,0.1); 
            border: 2px solid rgba(76,175,80,0.3); 
            color: #4caf50;
            padding: 12px 16px; 
            border-radius: 10px; 
            font-size: 13px; 
            font-weight: 800;
            cursor: pointer; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: all 0.3s ease;
        }
        .btn-gps-action:hover {
            background: rgba(76,175,80,0.15);
            border-color: rgba(76,175,80,0.5);
        }
        .btn-gps-action.activo { 
            background: #4caf50; 
            border-color: #4caf50; 
            color: white;
            box-shadow: 0 4px 12px rgba(76,175,80,0.4);
        }

        /* Estilos para botones de cambio */
        .btn-cambio {
            flex: 1;
            background: #1a1a1a;
            border: 2px solid #333;
            color: #888;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .btn-cambio:hover {
            border-color: rgba(244,180,0,0.5);
            background: rgba(244,180,0,0.05);
        }
        .btn-cambio.activo {
            background: var(--brand);
            border-color: var(--brand);
            color: #000;
            font-weight: 900;
            box-shadow: 0 4px 12px rgba(244,180,0,0.3);
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        /* CORRECCI√ìN CR√çTICA PARA PREVENIR DESBORDAMIENTO HORIZONTAL */
        .menu-wrapper,
        .form-modal,
        .cart-float,
        #full-menu,
        .menu-section {
            max-width: 100vw;
            box-sizing: border-box;
        }
        
        img {
            max-width: 100%;
            height: auto;
        }
        
        @media (max-width: 400px) {
            #menu-container { grid-template-columns: 1fr; }
            .hero-title { font-size: 20px; }
            .hero-tagline { font-size: 12px; }
            .hero-logo { width: 55px; height: 55px; }
            .hero-cta { padding: 10px 22px; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="fire-canvas" id="dynamic-bg"><div class="sparks"></div></div>

<header id="main-header">
    <div class="logo-container"><img src="https://i.ibb.co/tTKrch7P/Whats-App-Image-2026-01-31-at-4-04-56-PM.jpg" alt="Logo J&M Fast Food"></div>
    <h1 class="fire-text">J&M FAST FOOD</h1>
</header>

<!-- HERO SECTION -->
<section class="hero">
    <div class="hero-bg"></div>
    <div class="hero-logo">
        <img src="https://i.ibb.co/tTKrch7P/Whats-App-Image-2026-01-31-at-4-04-56-PM.jpg" alt="J&M Fast Food Logo">
    </div>
    <h2 class="hero-title">J&M FAST FOOD</h2>
    <p class="hero-tagline">Sabor que enamora desde el primer mordisco</p>
    <div class="hero-badges">
        <span class="hero-badge">ENV√çO GRATIS +$30.000</span>
        <span class="hero-badge">100% CARNE PREMIUM</span>
        <span class="hero-badge">LISTO EN 30 MIN</span>
    </div>
    <button class="hero-cta" onclick="document.getElementById('full-menu').scrollIntoView({behavior:'smooth'})">
        VER MENU COMPLETO
    </button>
    <div class="hero-scroll-indicator">
        <span>Desliza</span>
        <span>&#8595;</span>
    </div>
</section>

<!-- BOT√ìN INSTALAR APP -->
<button class="install-btn" id="install-btn" onclick="instalarApp()">
    <span>üì±</span>
    <span>INSTALAR APP</span>
</button>

<div class="menu-wrapper">
    <div class="tabs" id="tab-bar"></div>
    <div id="full-menu"></div>
</div>

<button class="cart-float" id="cart-bar" onclick="showForm()">
    <span>MI PEDIDO</span>
    <div class="cart-black-box">
        <div id="cart-count">0</div>
        <span>üõí</span>
        <span id="total-txt">$0</span>
    </div>
</button>

<div class="form-modal" id="form-modal">
    <button class="close-modal" onclick="cerrarForm()">‚úï</button>
    <h2 style="color:var(--brand); text-align:center; margin:35px 0 15px; font-weight:900;">CONFIRMAR PEDIDO</h2>
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button id="btn-domicilio" style="flex:1; padding:15px; border-radius:12px; border:none; background:var(--brand); font-weight:900;" onclick="setEntrega('Domicilio')">üõµ Domicilio</button>
        <button id="btn-tienda" style="flex:1; padding:15px; border-radius:12px; border:none; background:#1a1a1a; color:#fff;" onclick="setEntrega('Tienda')">üè™ Recoger</button>
    </div>

    <div id="resumen-lista" class="resumen-box"></div>

    <label style="color:var(--brand); font-size:12px; font-weight:700; margin-left:5px; display:block; margin-bottom:5px;">M√âTODO DE PAGO:</label>
    <select id="tipoPago" class="input-field" onchange="toggleCambioEfectivo()">
        <option value="Efectivo">üíµ Efectivo</option>
        <option value="Transferencia (Nequi/Daviplata)">üí≥ Transferencia</option>
    </select>

    <!-- Campo para cambio (solo visible si selecciona efectivo) -->
    <div id="div-cambio-efectivo" style="margin-top:12px; display:block;">
        <label style="color:var(--brand); font-size:12px; font-weight:700; margin-left:5px; display:block; margin-bottom:5px;">üí∞ ¬øNECESITAS CAMBIO?</label>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button type="button" id="btn-no-cambio" class="btn-cambio activo" onclick="seleccionarCambio('no')">
                ‚úì No necesito
            </button>
            <button type="button" id="btn-si-cambio" class="btn-cambio" onclick="seleccionarCambio('si')">
                S√≠, con cu√°nto pago
            </button>
        </div>
        <input 
            type="number" 
            id="monto-cambio" 
            class="input-field" 
            placeholder="Ej: 50000" 
            style="display:none;"
        >
        <p id="mensaje-cambio" style="margin:8px 5px 0; font-size:11px; color:#4caf50; display:none;">
            üí° El domiciliario llevar√° cambio para <span id="valor-pago-con"></span>
        </p>
    </div>

    <input type="text" id="cliente" class="input-field" placeholder="Nombre completo *">
    <input type="tel" id="telefono" class="input-field" placeholder="WhatsApp *">
    
    <div id="div-domicilio">
        <!-- Formulario de direcci√≥n SIMPLIFICADO -->
        <label style="color:var(--brand); font-size:12px; font-weight:700; margin-left:5px; display:block; margin-bottom:5px;">üìç DIRECCI√ìN DE ENTREGA:</label>
        
        <textarea 
            id="direccion-completa" 
            class="input-field" 
            placeholder="Ej: Calle 45 #23-10, Apto 301, Torre B, Boston, Barranquilla
Referencia: Edificio azul al lado del supermercado" 
            style="min-height:85px; resize:vertical; font-family: inherit;"
        ></textarea>
        
        <div style="background:rgba(76,175,80,0.08); border:1px solid rgba(76,175,80,0.25); border-radius:12px; padding:12px; margin-top:10px; margin-bottom:12px;">
            <p style="margin:0 0 10px 0; font-size:11px; color:#aaa; text-align:center; line-height:1.5;">
                üí° <b style="color:#4caf50;">Opcional:</b> ¬øEst√°s en el lugar de entrega ahora?<br>
                <span style="font-size:10px; color:#999;">Agrega tu ubicaci√≥n GPS para que el domiciliario te encuentre m√°s f√°cil</span>
            </p>
            <button type="button" class="btn-gps-action" id="gps-trigger" onclick="obtenerUbicacion()">
                <span id="gps-icon">üìç</span>
                <span id="gps-text">AGREGAR MI UBICACI√ìN GPS</span>
            </button>
        </div>
        
        <input type="hidden" id="gps-hidden-value">
        <input type="hidden" id="gps-activado" value="false">
    </div>
    
    <button id="btn-enviar" style="background:var(--brand); padding:20px; border-radius:15px; border:none; font-weight:900; cursor:pointer; font-size:16px; margin-top:10px;" onclick="enviarPedido()">PEDIR POR WHATSAPP üöÄ</button>
</div>


<style>
</style>

<script>
const SHEET_ID = '12KJLmF_Xvg0QficA4Zx3g7l0dYNEwd0O_PFcG8TfTlI';
const WHATSAPP = '573334311652';
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

// Configuraci√≥n de domicilios (ajusta las coordenadas de tu restaurante)
const DIRECCION_BASE = {
    lat: 10.962536,  // Latitud de J&M Fast Food
    lng: -74.814391  // Longitud de J&M Fast Food
};

const TARIFA_BASE = 3000;           // Tarifa m√≠nima de domicilio
const TARIFA_POR_KM = 1000;        // Costo por kil√≥metro adicional
const DISTANCIA_GRATIS = 2;        // Primeros 2km con tarifa base
const DISTANCIA_MAXIMA = 10;       // M√°ximo 10km de cobertura

let allItems = []; let cart = {}; let timers = {}; let modoEntrega = 'Domicilio';

// Generar color √∫nico para cada categor√≠a
function generarColorCategoria(texto) {
    let hash = 0;
    for (let i = 0; i < texto.length; i++) {
        hash = texto.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    // Generar HSL con saturaci√≥n y luminosidad controladas para colores suaves
    const h = Math.abs(hash % 360);
    const s = 65 + (hash % 20); // 65-85% saturaci√≥n
    const l = 50 + (hash % 15); // 50-65% luminosidad
    
    return `hsl(${h}, ${s}%, ${l}%)`;
}

// Aplicar colores a las categor√≠as
function aplicarColoresCategoria() {
    const sections = document.querySelectorAll('.menu-section');
    
    sections.forEach((section, index) => {
        const categoryName = section.id.replace('cat-', '');
        const color = generarColorCategoria(categoryName);
        
        // Aplicar color al fondo de la secci√≥n
        section.style.setProperty('--category-color', color);
        section.querySelector('.category-title').style.color = color;
        
        // Fondo degradado transparente
        section.style.background = `linear-gradient(180deg, 
            ${color}08 0%, 
            transparent 30%, 
            transparent 70%, 
            ${color}05 100%)`;
        
        // Aplicar color a las tarjetas de esta categor√≠a
        const items = section.querySelectorAll('.item');
        items.forEach(item => {
            item.style.setProperty('--category-color', color);
        });
    });
}

// Detectar categor√≠a visible y activar efectos
function detectarCategoriaVisible() {
    const sections = document.querySelectorAll('.menu-section');
    const tabs = document.querySelectorAll('.tabs button');
    const bg = document.getElementById('dynamic-bg');
    
    let categoriaActual = null;
    
    sections.forEach((section, index) => {
        const rect = section.getBoundingClientRect();
        const isVisible = rect.top < window.innerHeight / 2 && rect.bottom > window.innerHeight / 2;
        
        if (isVisible) {
            categoriaActual = section.id.replace('cat-', '');
            section.classList.add('active');
            
            // Activar tab correspondiente
            tabs.forEach(tab => {
                const tabText = tab.textContent.trim();
                if (tabText === categoriaActual) {
                    tab.classList.add('active');
                    const color = generarColorCategoria(categoriaActual);
                    tab.style.setProperty('--category-color', color);
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // NUEVO: Cambiar color de fondo din√°micamente
            const color = generarColorCategoria(categoriaActual);
            const colorOpaco = color.replace('hsl', 'hsla').replace(')', ', 0.15)');
            bg.style.setProperty('--category-bg-color', colorOpaco);
            bg.classList.add('active-category');
        } else {
            section.classList.remove('active');
        }
    });
}

function parsearLineaCSV(linea) {
    const resultado = [];
    let actual = '';
    let entreComillas = false;
    
    for (let i = 0; i < linea.length; i++) {
        const char = linea[i];
        if (char === '"') {
            entreComillas = !entreComillas;
        } else if (char === ',' && !entreComillas) {
            resultado.push(actual.trim().replace(/"/g,''));
            actual = '';
        } else {
            actual += char;
        }
    }
    resultado.push(actual.trim().replace(/"/g,''));
    return resultado;
}

async function loadData() {
    // Mostrar indicador de carga
    document.getElementById('full-menu').innerHTML = 
        '<div style="text-align:center; padding:50px; color:var(--brand);">‚åõ Cargando men√∫...</div>';
    
    try {
        const r = await fetch(URL);
        const csv = await r.text();
        const rows = csv.split('\n').slice(1);
        allItems = rows.map(row => {
            const cols = parsearLineaCSV(row);
            return { 
                cat: cols[0]?.trim(), 
                name: cols[1]?.trim(), 
                price: Number(cols[2]), 
                desc: cols[3]?.trim(), 
                img: cols[4]?.trim() 
            };
        }).filter(p => p.name);
        renderMenu();
        
        // Aplicar colores a las categor√≠as
        setTimeout(() => {
            aplicarColoresCategoria();
            detectarCategoriaVisible();
        }, 100);
        
        // Detectar scroll para activar efectos de categor√≠a
        window.addEventListener('scroll', detectarCategoriaVisible);
    } catch (e) { 
        console.error("Error cargando men√∫:", e);
        document.getElementById('full-menu').innerHTML = 
            '<div style="text-align:center; padding:50px; color:var(--error);">‚ùå Error al cargar el men√∫.<br><button onclick="loadData()" style="margin-top:20px; padding:10px 20px; background:var(--brand); border:none; border-radius:10px; cursor:pointer; font-weight:700;">Reintentar</button></div>';
    }
}

function renderMenu() {
    const cats = [...new Set(allItems.map(i => i.cat))];
    document.getElementById('tab-bar').innerHTML = cats.map((c, idx) => 
        `<button onclick="scrollToCat('${c}')" id="tab-${c.replace(/\s/g, '')}" class="${idx===0?'active':''}">
            <span>${c}</span>
        </button>`
    ).join('');
    
    document.getElementById('full-menu').innerHTML = cats.map(c => `
        <section id="cat-${c.replace(/\s/g, '')}" class="menu-section ${cats.indexOf(c)===0?'active':''}">
            <h2 class="category-title">${c}</h2>
            <div id="menu-container">
                ${allItems.filter(i => i.cat === c).map(p => {
                    const id = encodeURIComponent(p.name);
                    const isExp = cart[p.name] ? 'expanded' : '';
                    return `
                    <div class="item">
                        <div class="item-img-cont">
                            ${p.img ? `<img src="${p.img}" alt="${p.name}">` : `<span style="font-size:40px;">üçî</span>`}
                            <div class="qty-btn ${isExp}" id="qty-btn-${id}" onclick="expandBtn('${p.name}', ${p.price}, '${p.cat}')">
                                ${cart[p.name] ? 
                                    `<button onclick="changeQty(event,'${p.name}',-1)">-</button><span id="val-${id}">${cart[p.name].qty}</span><button onclick="changeQty(event,'${p.name}',1)">+</button>` 
                                    : `<span>+</span>`}
                            </div>
                        </div>
                        <div class="item-info">
                            <div class="item-name">${p.name}</div>
                            <div class="item-desc">${p.desc || ''}</div>
                            <div class="item-price">$${p.price.toLocaleString('es-CO')}</div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </section>
    `).join('');
}

function scrollToCat(c) {
    const id = c.replace(/\s/g, '');
    const element = document.getElementById(`cat-${id}`);
    const tabsHeight = document.querySelector('.tabs').offsetHeight;
    const promoHeight = document.querySelector('.promo-banner').offsetHeight;
    const headerHeight = document.querySelector('header').offsetHeight;
    window.scrollTo({ top: element.offsetTop - tabsHeight - promoHeight - headerHeight - 10, behavior: 'smooth' });
}

function highlightTab(id) {
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    const activeTab = document.getElementById(`tab-${id}`);
    if (activeTab) {
        activeTab.classList.add('active');
        
        // Aplicar color de la categor√≠a al tab activo
        const categoryName = id;
        const color = generarColorCategoria(categoryName);
        activeTab.style.setProperty('--category-color', color);
        
        const container = document.getElementById('tab-bar');
        container.scrollTo({ left: activeTab.offsetLeft - (container.offsetWidth / 2) + (activeTab.offsetWidth / 2), behavior: 'smooth' });
    }
}

window.addEventListener('scroll', () => {
    let current = "";
    const offset = 200;
    document.querySelectorAll('.menu-section').forEach(section => {
        if (pageYOffset >= section.offsetTop - offset) current = section.getAttribute('id').replace('cat-', '');
    });
    if (current) highlightTab(current);
});

function expandBtn(name, price, cat) {
    const btnId = `qty-btn-${encodeURIComponent(name)}`;
    const btn = document.getElementById(btnId);
    
    if(!cart[name]) { 
        cart[name] = { price, qty: 1, cat, note: "" };
        // Solo actualizar el bot√≥n espec√≠fico en lugar de re-renderizar todo
        btn.classList.add('expanded');
        btn.innerHTML = `<button onclick="changeQty(event,'${name}',-1)">-</button><span id="val-${encodeURIComponent(name)}">${cart[name].qty}</span><button onclick="changeQty(event,'${name}',1)">+</button>`;
        updateCartUI(); 
    } else {
        btn.classList.add('expanded');
    }
    resetTimer(name);
}

function resetTimer(name) {
    // Cerrar todos los dem√°s botones expandidos
    document.querySelectorAll('.qty-btn.expanded').forEach(btn => {
        const btnName = btn.id.replace('qty-btn-', '');
        if(decodeURIComponent(btnName) !== name) {
            btn.classList.remove('expanded');
            if(timers[decodeURIComponent(btnName)]) {
                clearTimeout(timers[decodeURIComponent(btnName)]);
            }
        }
    });
    
    if(timers[name]) clearTimeout(timers[name]);
    timers[name] = setTimeout(() => {
        const btn = document.getElementById(`qty-btn-${encodeURIComponent(name)}`);
        if(btn) btn.classList.remove('expanded');
    }, 2500);
}

function changeQty(e, name, delta) {
    if(e) e.stopPropagation();
    
    if(!cart[name]) return; // Seguridad extra
    
    cart[name].qty += delta;
    const btnId = `qty-btn-${encodeURIComponent(name)}`;
    const btn = document.getElementById(btnId);
    
    if(cart[name].qty <= 0) { 
        delete cart[name];
        // Solo actualizar este bot√≥n espec√≠fico
        if(btn) {
            btn.classList.remove('expanded');
            btn.innerHTML = '<span>+</span>';
        }
    } else { 
        const valSpan = document.getElementById(`val-${encodeURIComponent(name)}`);
        if(valSpan) valSpan.innerText = cart[name].qty;
        resetTimer(name); 
    }
    updateCartUI();
    if(document.getElementById('form-modal').style.display === 'flex') showForm();
}

function updateCartUI() {
    let total = 0; let count = 0;
    Object.values(cart).forEach(i => { total += (i.price * i.qty); count += i.qty; });
    document.getElementById('cart-bar').style.display = total > 0 ? 'flex' : 'none';
    document.getElementById('total-txt').innerText = '$' + total.toLocaleString('es-CO');
    document.getElementById('cart-count').innerText = count;
}

function showForm() {
    const resumen = document.getElementById('resumen-lista');
    let html = ""; let total = 0;
    const grupos = {};
    
    Object.keys(cart).forEach(n => {
        const i = cart[n]; if(!grupos[i.cat]) grupos[i.cat] = [];
        grupos[i.cat].push({nombre:n, ...i});
    });

    Object.keys(grupos).forEach(c => {
        html += `<div style="color:var(--brand); font-size:11px; font-weight:900; margin:15px 0 5px; text-transform:uppercase; letter-spacing:1px;">${c}</div>`;
        grupos[c].forEach(item => {
            total += item.price * item.qty;
            html += `
            <div style="margin-bottom:12px; border-bottom:1px solid #222; padding-bottom:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex-grow:1;">
                        <div style="font-weight:700; font-size:14px;">${item.nombre}</div>
                        <div style="color:var(--brand); font-size:13px;">$${(item.price*item.qty).toLocaleString('es-CO')}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; background:#222; padding:4px 10px; border-radius:15px;">
                        <button onclick="changeQty(null, '${item.nombre}',-1)" style="color:var(--brand); border:none; background:none; font-weight:900; cursor:pointer; width:25px;">-</button>
                        <span style="min-width:15px; text-align:center;">${item.qty}</span>
                        <button onclick="changeQty(null, '${item.nombre}',1)" style="color:var(--brand); border:none; background:none; font-weight:900; cursor:pointer; width:25px;">+</button>
                    </div>
                </div>
                <input type="text" placeholder="Nota: Sin cebolla, etc..." value="${item.note}" 
                    oninput="cart['${item.nombre}'].note=this.value" 
                    style="width:100%; background:rgba(0,0,0,0.3); border:1px dashed #333; color:#eee; padding:8px; font-size:12px; outline:none; margin-top:5px; border-radius:8px;">
            </div>`;
        });
    });

    const notaDomicilio = modoEntrega === 'Domicilio' 
        ? `<div style="background:rgba(244,180,0,0.1); color:var(--brand); padding:10px; border-radius:10px; font-size:11px; margin-top:10px; text-align:center;">‚ö†Ô∏è <b>TOTAL PARCIAL:</b> El costo del env√≠o se acordar√° por WhatsApp.</div>` 
        : '';

    html += `<div style="display:flex; justify-content:space-between; font-weight:900; color:var(--brand); font-size:18px; margin-top:15px;"><span>TOTAL</span><span>$${total.toLocaleString('es-CO')}</span></div>${notaDomicilio}`;
    resumen.innerHTML = html;
    document.getElementById('form-modal').style.display = 'flex';
}

function setEntrega(t) {
    modoEntrega = t;
    document.getElementById('btn-domicilio').style.background = t==='Domicilio'? 'var(--brand)':'#1a1a1a';
    document.getElementById('btn-domicilio').style.color = t==='Domicilio'? '#000':'#fff';
    document.getElementById('btn-tienda').style.background = t==='Tienda'? 'var(--brand)':'#1a1a1a';
    document.getElementById('btn-tienda').style.color = t==='Tienda'? '#000':'#fff';
    document.getElementById('div-domicilio').style.display = t==='Tienda'?'none':'block';
    showForm();
}

function cerrarForm() { document.getElementById('form-modal').style.display = 'none'; }

// Funciones para manejo de cambio
function toggleCambioEfectivo() {
    const tipoPago = document.getElementById('tipoPago').value;
    const divCambio = document.getElementById('div-cambio-efectivo');
    
    if(tipoPago === 'Efectivo') {
        divCambio.style.display = 'block';
    } else {
        divCambio.style.display = 'none';
    }
}

function seleccionarCambio(opcion) {
    const btnNoCambio = document.getElementById('btn-no-cambio');
    const btnSiCambio = document.getElementById('btn-si-cambio');
    const montoCambio = document.getElementById('monto-cambio');
    const mensajeCambio = document.getElementById('mensaje-cambio');
    
    if(opcion === 'no') {
        btnNoCambio.classList.add('activo');
        btnSiCambio.classList.remove('activo');
        montoCambio.style.display = 'none';
        mensajeCambio.style.display = 'none';
        montoCambio.value = '';
    } else {
        btnNoCambio.classList.remove('activo');
        btnSiCambio.classList.add('activo');
        montoCambio.style.display = 'block';
        
        // Auto-focus en el input
        setTimeout(() => montoCambio.focus(), 100);
    }
}

// Actualizar mensaje cuando escribe el monto
document.addEventListener('DOMContentLoaded', function() {
    const montoCambio = document.getElementById('monto-cambio');
    if(montoCambio) {
        montoCambio.addEventListener('input', function() {
            const mensajeCambio = document.getElementById('mensaje-cambio');
            const valorPagoCon = document.getElementById('valor-pago-con');
            
            if(this.value && this.value > 0) {
                valorPagoCon.textContent = '$' + parseInt(this.value).toLocaleString('es-CO');
                mensajeCambio.style.display = 'block';
            } else {
                mensajeCambio.style.display = 'none';
            }
        });
    }
});

function obtenerUbicacion() {
    const btn = document.getElementById('gps-trigger');
    const hidden = document.getElementById('gps-hidden-value');
    const gpsActivado = document.getElementById('gps-activado');
    const gpsIcon = document.getElementById('gps-icon');
    const gpsText = document.getElementById('gps-text');
    
    if (!navigator.geolocation) {
        alert("GPS no disponible en tu navegador");
        return;
    }
    
    // Cambiar estado del bot√≥n
    btn.disabled = true;
    gpsIcon.textContent = "‚åõ";
    gpsText.textContent = "DETECTANDO...";
    
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            // Guardar coordenadas GPS (solo coordenadas, NO direcci√≥n)
            hidden.value = `https://www.google.com/maps?q=${lat},${lng}`;
            gpsActivado.value = "true";
            
            // Activar bot√≥n en verde
            btn.classList.add('activo');
            gpsIcon.textContent = "‚úÖ";
            gpsText.textContent = "UBICACI√ìN AGREGADA";
            btn.disabled = false;
            
            // Mensaje sutil de confirmaci√≥n
            setTimeout(() => {
                gpsIcon.textContent = "üìç";
                gpsText.textContent = "UBICACI√ìN GPS ACTIVADA";
            }, 2000);
        },
        (error) => { 
            btn.disabled = false;
            gpsIcon.textContent = "üìç";
            gpsText.textContent = "AGREGAR MI UBICACI√ìN GPS";
            alert("No se pudo obtener la ubicaci√≥n. Verifica los permisos GPS."); 
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function enviarPedido() {
    const btn = document.getElementById('btn-enviar');
    
    // Evitar doble env√≠o
    if(btn.disabled) return;
    
    // Verificar que el carrito no est√© vac√≠o
    if(Object.keys(cart).length === 0) {
        alert("Tu carrito est√° vac√≠o");
        return;
    }
    
    const cli = document.getElementById('cliente');
    const tel = document.getElementById('telefono');
    const dirCompleta = document.getElementById('direccion-completa');
    const gpsLink = document.getElementById('gps-hidden-value').value;
    const pago = document.getElementById('tipoPago');
    let error = false;

    // Limpiar errores previos
    [cli, tel, dirCompleta].forEach(input => {
        if(input) input.classList.remove('required-error');
    });

    // Validar campos obligatorios con mejor feedback visual
    [cli, tel, (modoEntrega === 'Domicilio' ? dirCompleta : null)].forEach(input => {
        if (input && !input.value.trim()) {
            input.classList.add('required-error');
            input.style.borderColor = '#ff4444';
            input.style.borderWidth = '2px';
            setTimeout(() => {
                input.classList.remove('required-error');
                input.style.borderColor = '';
                input.style.borderWidth = '';
            }, 3000);
            error = true;
        }
    });

    if(error) {
        alert("‚ö†Ô∏è Por favor completa todos los campos marcados en rojo");
        return;
    }
    
    // Validar tel√©fono
    if(tel.value.trim().length < 10) {
        alert("üì± Por favor ingresa un n√∫mero de tel√©fono v√°lido (m√≠nimo 10 d√≠gitos)");
        tel.classList.add('required-error');
        tel.style.borderColor = '#ff4444';
        tel.style.borderWidth = '2px';
        setTimeout(() => {
            tel.classList.remove('required-error');
            tel.style.borderColor = '';
            tel.style.borderWidth = '';
        }, 3000);
        return;
    }
    
    // Validar cambio si es efectivo
    if(pago.value === 'Efectivo') {
        const btnSiCambio = document.getElementById('btn-si-cambio');
        const montoCambio = document.getElementById('monto-cambio');
        
        if(btnSiCambio.classList.contains('activo')) {
            if(!montoCambio.value || montoCambio.value <= 0) {
                alert("üí∞ Por favor ingresa con cu√°nto vas a pagar");
                montoCambio.style.borderColor = '#ff4444';
                montoCambio.style.borderWidth = '2px';
                setTimeout(() => {
                    montoCambio.style.borderColor = '';
                    montoCambio.style.borderWidth = '';
                }, 3000);
                return;
            }
            
            // Calcular total del pedido temporalmente para validar
            let totalTemp = 0;
            Object.keys(cart).forEach(n => {
                totalTemp += (cart[n].price * cart[n].qty);
            });
            
            if(parseInt(montoCambio.value) < totalTemp) {
                alert("üí∞ El monto con el que vas a pagar debe ser mayor o igual al total del pedido ($" + totalTemp.toLocaleString('es-CO') + ")");
                montoCambio.style.borderColor = '#ff4444';
                montoCambio.style.borderWidth = '2px';
                setTimeout(() => {
                    montoCambio.style.borderColor = '';
                    montoCambio.style.borderWidth = '';
                }, 3000);
                return;
            }
        }
    }

    let totalPedido = 0;
    const grupos = {};
    Object.keys(cart).forEach(n => {
        const item = cart[n];
        if(!grupos[item.cat]) grupos[item.cat] = [];
        grupos[item.cat].push({nombre: n, ...item});
        totalPedido += (item.price * item.qty);
    });

    let t = `üî• *NUEVO PEDIDO J&M*\n`;
    t += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    t += `üë§ *Cliente:* ${cli.value.trim()}\n`;
    t += `üì± *Tel:* ${tel.value.trim()}\n`;
    t += `üõµ *Entrega:* ${modoEntrega}\n`;
    if(modoEntrega==='Domicilio') {
        t += `üìç *Dir:* ${dirCompleta.value.trim()}\n`;
        if(gpsLink) t += `üó∫Ô∏è *GPS:* ${gpsLink}\n`;
    }
    t += `üí≥ *Pago:* ${pago.value}\n`;
    
    // Agregar informaci√≥n de cambio si seleccion√≥ efectivo
    if(pago.value === 'Efectivo') {
        const montoCambio = document.getElementById('monto-cambio');
        const btnSiCambio = document.getElementById('btn-si-cambio');
        
        if(btnSiCambio.classList.contains('activo') && montoCambio.value) {
            const valorCambio = parseInt(montoCambio.value);
            const vuelto = valorCambio - totalPedido;
            t += `üíµ *Paga con:* $${valorCambio.toLocaleString('es-CO')}\n`;
            t += `üí∞ *Cambio:* $${vuelto.toLocaleString('es-CO')}\n`;
        } else {
            t += `‚úÖ *No requiere cambio*\n`;
        }
    }
    
    t += `\nüõí *DETALLE DEL PEDIDO:*\n`;

    Object.keys(grupos).forEach(cat => {
        t += `\n*${cat.toUpperCase()}* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        grupos[cat].forEach(i => {
            t += `‚Ä¢ ${i.qty} x ${i.nombre.trim()} _($${(i.price * i.qty).toLocaleString('es-CO')})_\n`;
            if(i.note.trim()) t += `    ‚îî üìù *Nota:* _${i.note.trim()}_\n`;
        });
    });

    t += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    t += `üí∞ *TOTAL: $${totalPedido.toLocaleString('es-CO')}*`;

    // Deshabilitar bot√≥n temporalmente
    btn.disabled = true;
    btn.innerHTML = "PREPARANDO...";

    // En lugar de abrir WhatsApp directamente, mostrar confirmaci√≥n
    mostrarConfirmacionEnvio(t, totalPedido, modoEntrega);
    
    // Rehabilitar bot√≥n despu√©s de 2 segundos
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = "PEDIR POR WHATSAPP üöÄ";
    }, 2000);
}

function mostrarConfirmacionEnvio(mensaje, total, tipoEntrega) {
    const esDomicilio = tipoEntrega === 'Domicilio';
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:3000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px); animation:fadeIn 0.3s;">
            <div style="background:linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding:30px; border-radius:25px; max-width:420px; width:90%; border:2px solid var(--brand); box-shadow:0 20px 60px rgba(244,180,0,0.3); animation:slideUp 0.4s;">
                
                <div style="text-align:center; margin-bottom:25px;">
                    <div style="width:80px; height:80px; background:var(--brand); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:40px; animation:pulse 1s infinite;">
                        ‚úì
                    </div>
                    <h3 style="color:var(--brand); margin:0 0 8px 0; font-size:22px; font-weight:900;">¬°Pedido Listo!</h3>
                    <p style="color:#aaa; margin:0; font-size:14px;">
                        ${esDomicilio ? '<b style="color:#4caf50;">SUBTOTAL PRODUCTOS:</b>' : '<b>TOTAL:</b>'} 
                        <span style="color:#fff; font-weight:900; font-size:20px;">$${total.toLocaleString('es-CO')}</span>
                    </p>
                </div>

                ${esDomicilio ? `
                <div style="background:linear-gradient(135deg, rgba(76,175,80,0.12) 0%, rgba(76,175,80,0.05) 100%); border:1px solid rgba(76,175,80,0.3); border-radius:15px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; align-items:start; gap:12px;">
                        <div style="font-size:24px; line-height:1;">üõµ</div>
                        <div style="flex:1;">
                            <p style="margin:0 0 8px 0; color:#4caf50; font-size:13px; font-weight:900; line-height:1.4;">
                                COSTO DE DOMICILIO
                            </p>
                            <p style="margin:0; color:#ccc; font-size:12px; line-height:1.5;">
                                Nuestro asesor te indicar√° el valor del domicilio seg√∫n tu ubicaci√≥n antes de confirmar el pago. 
                                <b style="color:#fff;">El total final incluir√° productos + env√≠o.</b>
                            </p>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div style="background:rgba(255,255,255,0.03); border-radius:15px; padding:15px; margin-bottom:20px; border:1px solid #333;">
                    <p style="margin:0; color:#ccc; font-size:13px; text-align:center; line-height:1.6;">
                        Te vamos a redirigir a <b style="color:var(--brand);">WhatsApp</b> para confirmar tu pedido con nuestro equipo
                    </p>
                </div>

                <div style="display:flex; gap:10px;">
                    <button onclick="cerrarConfirmacion()" style="flex:1; background:#333; border:none; padding:15px; border-radius:12px; color:#fff; font-weight:700; cursor:pointer; font-size:14px; transition:all 0.3s;">
                        Cancelar
                    </button>
                    <button onclick="abrirWhatsApp(\`${mensaje.replace(/`/g, '\\`')}\`)" style="flex:2; background:var(--brand); border:none; padding:15px; border-radius:12px; color:#000; font-weight:900; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.3s;">
                        <span>Abrir WhatsApp</span>
                        <span style="font-size:18px;">üí¨</span>
                    </button>
                </div>
            </div>
        </div>
        <style>
            @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
            @keyframes slideUp { from { transform:translateY(30px); opacity:0; } to { transform:translateY(0); opacity:1; } }
            @keyframes pulse { 0%, 100% { transform:scale(1); } 50% { transform:scale(1.1); } }
        </style>
    `;
    modal.id = 'confirmacion-envio';
    document.body.appendChild(modal);
}

function cerrarConfirmacion() {
    const modal = document.getElementById('confirmacion-envio');
    if(modal) modal.remove();
}

function abrirWhatsApp(mensaje) {
    window.open(`https://api.whatsapp.com/send?phone=${WHATSAPP}&text=${encodeURIComponent(mensaje)}`, '_blank');
    
    // Limpiar carrito y cerrar modales
    Object.keys(cart).forEach(nombre => {
        const btnId = `qty-btn-${encodeURIComponent(nombre)}`;
        const botonProducto = document.getElementById(btnId);
        if(botonProducto) {
            botonProducto.classList.remove('expanded');
            botonProducto.innerHTML = '<span>+</span>';
        }
    });
    
    cart = {};
    updateCartUI();
    cerrarForm();
    cerrarConfirmacion();
}

loadData();

// Header scroll behavior
const header = document.getElementById('main-header');
const heroSection = document.querySelector('.hero');
window.addEventListener('scroll', () => {
    if (window.scrollY > heroSection.offsetHeight - 100) {
        header.classList.add('scrolled');
    } else {
        header.classList.remove('scrolled');
    }
});

// ============================================
// FUNCIONALIDAD PWA - INSTALAR COMO APP
// ============================================
let deferredPrompt;
const installBtn = document.getElementById('install-btn');

// Detectar si la app ya est√° instalada
function isAppInstalled() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true;
}

// Escuchar el evento beforeinstallprompt
window.addEventListener('beforeinstallprompt', (e) => {
    // Prevenir que Chrome muestre su banner autom√°tico
    e.preventDefault();
    // Guardar el evento para usarlo despu√©s
    deferredPrompt = e;
    
    // Mostrar el bot√≥n de instalaci√≥n si no est√° instalada
    if (!isAppInstalled()) {
        installBtn.classList.add('show');
    }
});

// Funci√≥n para instalar la app
function instalarApp() {
    if (!deferredPrompt) {
        alert('Para instalar esta app:\n\nüì± En Chrome/Edge: Men√∫ > "Instalar aplicaci√≥n"\nüçé En Safari iOS: Compartir > "A√±adir a pantalla de inicio"');
        return;
    }
    
    // Mostrar el prompt de instalaci√≥n
    deferredPrompt.prompt();
    
    // Esperar la respuesta del usuario
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('Usuario acept√≥ la instalaci√≥n');
            installBtn.classList.remove('show');
        } else {
            console.log('Usuario rechaz√≥ la instalaci√≥n');
        }
        deferredPrompt = null;
    });
}

// Ocultar bot√≥n si ya est√° instalada
if (isAppInstalled()) {
    installBtn.style.display = 'none';
}

// Registro del Service Worker (para PWA)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registrado:', registration);
            })
            .catch(error => {
                console.log('Error al registrar Service Worker:', error);
            });
    });
}
</script>



</body>
</html>
